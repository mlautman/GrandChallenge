% 3.1.3 Testing the Correctness of Gradient Computation
% Requires files sub001_mri.nii and sub002_mri.nii to be in the same directory

[image1,spacing] = myReadNifti('sub001_mri.nii');
[image2,spacing2] = myReadNifti('sub002_mri.nii');
p = [1,0,0,0,1,0,0,0,1,0,0,0]';

%gaussian LPF
sigma = 1;
smoothedimage1 = myGaussianLPF(image1,sigma);
smoothedimage2 = myGaussianLPF(image2,sigma);

%analytical gradient
[E,g] = myAffineObjective3D(p,smoothedimage1,smoothedimage2);

%numerical gradient
epsilon = 1e-4;
gnumer = ones(12,1);
for j = 1:12
    %Create ej vector
    ej = zeros(12,1);
    ej(j) = 1;
    
    %Add/subtract ej*epsilon vector to p
    pup = p + ones(12,1)*j*epsilon;
    pdown = p - ones(12,1)*j*epsilon;
    
    %Compute E terms for numerical gradient approximation
    [Eup,~] = myAffineObjective3D(pup,smoothedimage1,smoothedimage2);
    [Edown,~] = myAffineObjective3D(pdown,smoothedimage1,smoothedimage2);
    
    %Compute 
    gnumer(j) = (Eup - Edown)/(2*epsilon);
end

%Compute difference
diffvector = g - gnumer;
